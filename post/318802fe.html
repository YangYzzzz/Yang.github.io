<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>『操作系统』操作系统实验LAB6 Challenge | Yang's CS World</title><meta name="author" content="Yang"><meta name="copyright" content="Yang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="操作系统LAB6挑战性任务实验报告一.实现需求 指导书要求实现的功能：  一行多命令 后台任务操作符 &amp; 引号支持 “” 光标交互的完善，上下左右BACKSPACE功能实现以及协作交互 程序名称 .b 的省略 记录历史命令 更丰富的命令：支持tree; mkdir [-p]; touch [-p]; history 选做一：实现shell环境变量，支持declare [-xr]; unse">
<meta property="og:type" content="article">
<meta property="og:title" content="『操作系统』操作系统实验LAB6 Challenge">
<meta property="og:url" content="https://yangyzzzz.github.io/post/318802fe.html">
<meta property="og:site_name" content="Yang&#39;s CS World">
<meta property="og:description" content="操作系统LAB6挑战性任务实验报告一.实现需求 指导书要求实现的功能：  一行多命令 后台任务操作符 &amp; 引号支持 “” 光标交互的完善，上下左右BACKSPACE功能实现以及协作交互 程序名称 .b 的省略 记录历史命令 更丰富的命令：支持tree; mkdir [-p]; touch [-p]; history 选做一：实现shell环境变量，支持declare [-xr]; unse">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yangyzzzz.github.io/img/113646857_p0_master1700.jpeg">
<meta property="article:published_time" content="2024-10-08T04:03:15.000Z">
<meta property="article:modified_time" content="2024-10-09T03:42:58.867Z">
<meta property="article:author" content="Yang">
<meta property="article:tag" content="操作系统">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yangyzzzz.github.io/img/113646857_p0_master1700.jpeg"><link rel="shortcut icon" href="/img/avatar.jpeg"><link rel="canonical" href="https://yangyzzzz.github.io/post/318802fe.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d431d91edffce9d7bd7ade045956b24b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":10000,"languages":{"author":"作者: Yang","link":"链接: ","source":"来源: Yang's CS World","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '『操作系统』操作系统实验LAB6 Challenge',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-09 11:42:58'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/light.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/windmill.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/universe.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-comments"></i><span> 说说</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/113646857_p0_master1700.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="Yang's CS World"></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-comments"></i><span> 说说</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">『操作系统』操作系统实验LAB6 Challenge</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-08T04:03:15.000Z" title="发表于 2024-10-08 12:03:15">2024-10-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-09T03:42:58.867Z" title="更新于 2024-10-09 11:42:58">2024-10-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/">计算机科学</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>37分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="『操作系统』操作系统实验LAB6 Challenge"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/post/318802fe.html#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="操作系统LAB6挑战性任务实验报告"><a href="#操作系统LAB6挑战性任务实验报告" class="headerlink" title="操作系统LAB6挑战性任务实验报告"></a>操作系统LAB6挑战性任务实验报告</h1><h2 id="一-实现需求"><a href="#一-实现需求" class="headerlink" title="一.实现需求"></a>一.实现需求</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_1.jpg" alt></p>
<p>指导书要求实现的功能：</p>
<ul>
<li>一行多命令</li>
<li>后台任务操作符 <strong>&amp;</strong></li>
<li>引号支持 <strong>“”</strong></li>
<li>光标交互的完善，上下左右BACKSPACE功能实现以及协作交互</li>
<li>程序名称 .b 的省略</li>
<li>记录历史命令</li>
<li>更丰富的命令：支持tree; mkdir [-p]; touch [-p]; history</li>
<li>选做一：实现shell环境变量，支持declare [-xr]; unset</li>
<li>选做二：支持相对路径, 支持内部命令cd，pwd</li>
</ul>
<p>自己额外实现的功能：</p>
<ul>
<li>追加重定向 <strong>&gt;&gt;</strong></li>
<li>转义符 <strong>\</strong></li>
<li>支持上级目录 <strong>..</strong> , 当前目录 <strong>.</strong></li>
<li>更丰富的命令：支持 cp [-r]; mv; rm [-rf]; rmdir [-p]</li>
<li>命令与路径自动补全</li>
</ul>
<p>上述所有功能皆以 Linux 的行为作为参照，某些地方存在差异。</p>
<h2 id="二-实现思路"><a href="#二-实现思路" class="headerlink" title="二. 实现思路"></a>二. 实现思路</h2><h3 id="1-一行多命令"><a href="#1-一行多命令" class="headerlink" title="1. 一行多命令"></a>1. 一行多命令</h3><p>核心代码如下，同管道机制，令父进程执行右面，子进程执行左面，父进程等待子进程结束后再开始执行。</p>
<p><strong>sh.c</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;;&#x27;</span>: <span class="comment">//依次执行左右两边的指令</span></span><br><span class="line">    <span class="keyword">if</span> ((r = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123; <span class="comment">//父进程</span></span><br><span class="line">        <span class="built_in">wait</span>(r); <span class="comment">//等待子进程结束</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parsecmd</span>(argv, rightpipe);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> argc;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>测试如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_2.jpg" alt></p>
<h3 id="2-后台命令"><a href="#2-后台命令" class="headerlink" title="2. 后台命令"></a>2. 后台命令</h3><p>基本同一行多命令，只不过父进程不再等待子进程结束，而是同步执行。由于在父进程执行完命令后shell便会开始读取新一行的指令，而控制台读取字符的方式是忙等，即CPU轮询，因此会出现父进程执行完后子进程还未执行完，直到输入下一条命令后子进程的输出才会显示出来的现象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;&amp;&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> ((r = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot; &amp; fork error!!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123; <span class="comment">//父进程执行右面，当右面执行完毕，即可开始下一次轮询获取指令 </span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parsecmd</span>(argv, rightpipe);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//子进程执行左面</span></span><br><span class="line">        <span class="keyword">return</span> argc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>测试如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_4.jpg" alt></p>
<h3 id="3-引号支持"><a href="#3-引号支持" class="headerlink" title="3. 引号支持"></a>3. 引号支持</h3><p>支持引号，支持转义 \ 和 “ ，由于转义会忽略 \ ，使用原先的输入序列进行字符串切割分割为许多子串的方法会出现问题，因此开了二维字符串数组来存储处理过的token。</p>
<p><strong>_gettoken</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> w[<span class="number">128</span>][<span class="number">128</span>];</span><br><span class="line"><span class="type">int</span> wcnt;</span><br><span class="line"></span><br><span class="line">wcnt++;</span><br><span class="line"><span class="keyword">while</span> (*s &amp;&amp; !<span class="built_in">strchr</span>(WHITESPACE SYMBOLS, *s)) &#123; <span class="comment">//读过整个单词</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in">strchr</span>(<span class="string">&quot;\&quot;&quot;</span>, *s)) &#123;</span><br><span class="line">		s++;</span><br><span class="line">		<span class="keyword">while</span>(*s &amp;&amp; !<span class="built_in">strchr</span>(<span class="string">&quot;\&quot;&quot;</span>, *s)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strchr</span>(<span class="string">&quot;\\&quot;</span>, *s) &amp;&amp; <span class="built_in">strchr</span>(<span class="string">&quot;\&quot;\\&quot;</span>, *(s + <span class="number">1</span>))) &#123; <span class="comment">// \\ \&quot; </span></span><br><span class="line">				s++;</span><br><span class="line">			&#125;</span><br><span class="line">			w[wcnt][c++] = *s;</span><br><span class="line">			s++;</span><br><span class="line">		&#125;</span><br><span class="line">		s++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strchr</span>(<span class="string">&quot;\\&quot;</span>, *s) &amp;&amp; <span class="built_in">strchr</span>(<span class="string">&quot;\&quot;\\&quot;</span>, *(s + <span class="number">1</span>))) &#123;</span><br><span class="line">		s++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//debugf(&quot; %c &quot;, *s);</span></span><br><span class="line">	w[wcnt][c++] = *s;</span><br><span class="line">	s++;</span><br><span class="line">&#125;</span><br><span class="line">*p2 = s;</span><br><span class="line">w[wcnt][c] = <span class="number">0</span>; <span class="comment">//封0</span></span><br><span class="line">*p1 = w[wcnt];</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;w&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>基本功能与linux保持一致，测试如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_3.jpg" alt></p>
<h3 id="4-光标交互"><a href="#4-光标交互" class="headerlink" title="4. 光标交互"></a>4. 光标交互</h3><p><strong>这一部分是本实验第一大难点。</strong>课程组给好的shell无法删除，也只能在光标处进行修改字符，而且修改后也无法正常运行，这是由于<strong>输入逻辑与内部逻辑不匹配</strong>导致的，为方便后续功能的实现与测试，做好用户交互是重要的，因此笔者完全按照Linux的逻辑修改了光标交互，具体来说，按BACKSPACE可以删除光标后的字符，按LEFT和RIGHT可以调整光标的位置，输入字符时会<strong>增加</strong>而非<strong>替换</strong>，按UP和DOWN可以翻滚历史命令，并同样支持修改，总的来说与跳板机Linux无异。</p>
<p>首先，控制台有几个基本逻辑，这些逻辑不体现在代码上，应当是外设的逻辑：</p>
<ol>
<li>输出一个字符就在光标处的原本字符替换为该字符 且光标前移一个，控制符包括\0不会改变光标位置</li>
<li>right left 只会让光标左移右移，backspace 对光标无影响</li>
<li>上键光标会往上一格 而下键不会往下一格</li>
</ol>
<p>用到的ASCII码，其中上下左右键由三个ASCII码组成</p>
<ul>
<li>up: 27 91 65</li>
<li>down: 27 91 66</li>
<li>left: 27 91 68</li>
<li>right: 27 91 67</li>
<li>backspace: 127。</li>
</ul>
<p>刚刚提到逻辑不匹配的问题，因此我们除了维护<strong>输入序列</strong>外还需维护一个<strong>真正待执行的指令字符串序列</strong>，并维护字符串长度 max 以及当前光标的位置 pointer。在显示上，使用输出空格和\b退格的方式调整光标的位置和可视化指令序列，其重点在于既要修改外部显示又要修改内部指令序列，确保<strong>眼见必定为实</strong>。</p>
<p>核心代码如下，经过后续大量测试正确性得以保证：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">readline</span><span class="params">(<span class="type">char</span> *buf, <span class="type">char</span> *buf1, u_int n)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf1, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="type">int</span> pointer = <span class="number">0</span>; <span class="comment">//指向光标所在位置</span></span><br><span class="line">    <span class="type">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> history = <span class="built_in">open</span>(<span class="string">&quot;cmd.history&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="type">int</span> hispointer = <span class="built_in">get_file_size</span>(history); <span class="comment">//记录file的屁股</span></span><br><span class="line">    <span class="type">int</span> i, j, k;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((r = <span class="built_in">read</span>(<span class="number">0</span>, buf + i, <span class="number">1</span>)) != <span class="number">1</span>) &#123; <span class="comment">//从标准读入中读取数据</span></span><br><span class="line">            <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">debugf</span>(<span class="string">&quot;read error: %d\n&quot;</span>, r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (buf[i] == <span class="string">&#x27;\b&#x27;</span> || buf[i] == <span class="number">0x7f</span>) &#123; <span class="comment">//三种特殊情况</span></span><br><span class="line">            <span class="comment">//buf1[pointer] = &#x27; &#x27;;</span></span><br><span class="line">            <span class="keyword">if</span> (pointer != <span class="number">0</span>) &#123; <span class="comment">//删除 max--</span></span><br><span class="line">                <span class="type">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">                <span class="built_in">strcpy</span>(tmp, buf1 + pointer); <span class="comment">//从pointer到最后暂存起来</span></span><br><span class="line">                <span class="keyword">if</span> (buf[i] != <span class="string">&#x27;\b&#x27;</span>) &#123; <span class="comment">//输出一个回退字符 回退光标同步</span></span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>); <span class="comment">//到后面一格</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; max - pointer; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, tmp[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; max - pointer + <span class="number">1</span>; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">                &#125; <span class="comment">//多回退一个</span></span><br><span class="line">                pointer--;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>, k = pointer; tmp[j] != <span class="number">0</span>; j++, k++) &#123;</span><br><span class="line">                    buf1[k] = tmp[j]; <span class="comment">//修改buf1中内容</span></span><br><span class="line">                &#125;</span><br><span class="line">                buf1[k] = <span class="number">0</span>;</span><br><span class="line">                max--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (buf[i] == <span class="number">27</span>) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            r = <span class="built_in">read</span>(<span class="number">0</span>, buf+i, <span class="number">1</span>);</span><br><span class="line">            i++;</span><br><span class="line">            r = <span class="built_in">read</span>(<span class="number">0</span>, buf+i, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (buf[i] == <span class="number">68</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pointer != <span class="number">0</span>) &#123;</span><br><span class="line">                    pointer--;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buf[i] == <span class="number">67</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pointer &lt; max) &#123;</span><br><span class="line">                    pointer++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buf[i] == <span class="number">65</span>) &#123; <span class="comment">//up</span></span><br><span class="line">                <span class="comment">//debugf(&quot;\n21373037:(%s)$ &quot;, env-&gt;env_workingpath); //往上滚了 所以要换行一下到原来的位置</span></span><br><span class="line">                <span class="built_in">debugf</span>(<span class="string">&quot;%c%c%c&quot;</span>, <span class="number">27</span>, <span class="number">91</span>, <span class="number">66</span>); <span class="comment">//下移</span></span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; pointer; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>); <span class="comment">//没刷掉</span></span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; max; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; max; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">uphistory</span>(buf1, &amp;hispointer);</span><br><span class="line">                pointer = <span class="built_in">strlen</span>(buf1);</span><br><span class="line">                max = pointer;</span><br><span class="line">                <span class="comment">//debugf(&quot;poi : %d\n &quot;, pointer);</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buf[i] == <span class="number">66</span>) &#123;</span><br><span class="line">                <span class="comment">//debugf(&quot;%c%c%c&quot;, 27, 91, 65); //上移</span></span><br><span class="line">                <span class="comment">//debugf(&quot;\n21373037:(%s)$ &quot;, env-&gt;env_workingpath);</span></span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; pointer; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; max; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; max; j++) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">downhistory</span>(buf1, &amp;hispointer);</span><br><span class="line">                pointer = <span class="built_in">strlen</span>(buf1);</span><br><span class="line">                max = pointer;</span><br><span class="line">                <span class="comment">//debugf(&quot;poi : %d\n&quot;, pointer);</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (buf[i] == <span class="string">&#x27;\r&#x27;</span> || buf[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            buf[i] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">        <span class="built_in">strcpy</span>(tmp, buf1 + pointer); <span class="comment">//暂存指针之后所有内容</span></span><br><span class="line">        <span class="comment">//printf(&quot;%c&quot;, buf[i]); //正常情况</span></span><br><span class="line">        buf1[pointer] = buf[i];</span><br><span class="line">        pointer++;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>, k = pointer; j &lt; <span class="built_in">strlen</span>(tmp); j++, k++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, tmp[j]);</span><br><span class="line">            buf1[k] = tmp[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(tmp); j++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        max++; <span class="comment">//记录最大长度</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本功能用图不好展示，可以实际展示，使用时<strong>与Linux一模一样</strong>。</p>
<h3 id="5-程序名称-b的省略"><a href="#5-程序名称-b的省略" class="headerlink" title="5. 程序名称.b的省略"></a>5. 程序名称.b的省略</h3><p>最简单的一项，判断$argv[0]$（指令名称）结尾是否为$.b$，若不是，加上后缀即可。需要注意的是，若仍使用在原本字符串上切割的方式得到$argv[i]$的方法(即自带的方法)，则往后追加$.b$会占用到别的$argv$的空间，造成严重的错误，将$argv[0]$拷贝一份再追加是正确的选择。</p>
<h3 id="6-记录历史命令"><a href="#6-记录历史命令" class="headerlink" title="6. 记录历史命令"></a>6. 记录历史命令</h3><p>在shell执行开始时创建 cmd.history 文件，在每次读入命令后将该行命令追加到文件尾，以\n作为分隔符，追加写入即使用文件控制块得到文件大小再使用 seek 函数找到文件尾写入即可，追加重定向 &gt;&gt; 也是同样思路。</p>
<p>上下键的翻滚，需要动态维护一颗指针(永远指向\n的后一个字符)，初始时指向文件尾，向上翻滚则找到上一个\n，并读取两个\n中间的内容，向下翻滚则找到下一个\n，并读取再向下一行的内容。重点在于上下的临界情况要考虑清楚，若到达上下界再翻滚应当无事发生。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">uphistory</span><span class="params">(<span class="type">char</span> *buf1, <span class="type">int</span> *hispointer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(buf1, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (*hispointer == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//debugf(&quot;no up!&quot;);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> history = <span class="built_in">open</span>(<span class="string">&quot;cmd.history&quot;</span>, O_RDWR); <span class="comment">//从0开始</span></span><br><span class="line">    <span class="type">char</span> file[*hispointer];</span><br><span class="line">    <span class="type">int</span> last = <span class="number">0</span>, i;</span><br><span class="line">    <span class="type">int</span> n = <span class="built_in">read</span>(history, file, *hispointer); <span class="comment">//file找临近末尾的\n</span></span><br><span class="line">    <span class="comment">//debugf(&quot; %d &quot;, file[*hispointer - 1]); 换行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = *hispointer - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            last = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            last = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从Last 到 hispointer</span></span><br><span class="line">    <span class="keyword">for</span> (i = last; i &lt; *hispointer - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, file[i]);</span><br><span class="line">        buf1[i - last] = file[i];</span><br><span class="line">    &#125;</span><br><span class="line">    buf1[i - last] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">//把\n读走</span></span><br><span class="line">    *hispointer = last;</span><br><span class="line">    <span class="built_in">close</span>(history);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">downhistory</span><span class="params">(<span class="type">char</span> *buf1, <span class="type">int</span> *hispointer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(buf1, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="type">int</span> history = <span class="built_in">open</span>(<span class="string">&quot;cmd.history&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">seek</span>(history, *hispointer);</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="type">int</span> i, tmp;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++) &#123;</span><br><span class="line">        r = <span class="built_in">read</span>(history, buf1 + i, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//debugf(&quot; %d &quot;, buf1[i]);</span></span><br><span class="line">        <span class="keyword">if</span> (buf1[i] == <span class="number">0</span>) &#123; <span class="comment">//适用于一开始便在文件末尾处</span></span><br><span class="line">            <span class="comment">//debugf(&quot;no down!&quot;);</span></span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">debugf</span>(<span class="string">&quot;down wrong!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (buf1[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">//debugf(&quot; nextline &quot;);</span></span><br><span class="line">            tmp = *hispointer + i + <span class="number">1</span>; <span class="comment">//给pointer赋上值</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(buf1, <span class="number">0</span>, <span class="number">1024</span>); <span class="comment">//要回显的是再下一条</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++) &#123;</span><br><span class="line">        r = <span class="built_in">read</span>(history, buf1 + i, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (buf1[i] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//debugf(&quot;no down!&quot;);</span></span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">debugf</span>(<span class="string">&quot;doen wrong!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (buf1[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            *hispointer = tmp;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, buf1[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    buf1[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">close</span>(history);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>展示如下：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_5.jpg" alt></p>
<h3 id="7-更丰富的命令"><a href="#7-更丰富的命令" class="headerlink" title="7. 更丰富的命令"></a>7. 更丰富的命令</h3><p>与文件系统交互的指令大致分为两种，一种是只读文件结构，在用户进程便可处理，比如ls，tree；另一种需要对文件结构进行写入，笔者通过已经写到麻木的与文件服务进程交互的方式，通过文件服务进程对其修改。</p>
<h4 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h4><p>tree是输出文件系统树状结构，不涉及改变文件结构，仿照ls递归输出即可，笔者特别对目录和文件在输出时做出了区分。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> deepth = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">tree</span><span class="params">(<span class="type">char</span> *path, <span class="type">char</span> *name)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="type">int</span> fd, n;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> f;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Stat</span> st;</span><br><span class="line">    <span class="keyword">if</span> ((r = <span class="built_in">stat</span>(path, &amp;st)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">user_panic</span>(<span class="string">&quot;stat fail!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((fd = <span class="built_in">open</span>(path, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">user_panic</span>(<span class="string">&quot;open fail!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!st.st_isdir) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;|&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; deepth; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;----&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, name);</span><br><span class="line">        deepth--;</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((n = <span class="built_in">readn</span>(fd, &amp;f, <span class="keyword">sizeof</span> f)) == <span class="keyword">sizeof</span> f) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f.f_name[<span class="number">0</span>]) &#123; <span class="comment">//寻找dir的下层 只有是目录时要输出名字 文件时在上面输出</span></span><br><span class="line">            deepth++;</span><br><span class="line">            <span class="keyword">if</span> (f.f_type == FTYPE_DIR) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;|&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; deepth; i++) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;----&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;*%s\n&quot;</span>, f.f_name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> len = <span class="built_in">strlen</span>(f.f_name) + <span class="built_in">strlen</span>(path) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">char</span> newpath[len + <span class="number">1</span>];</span><br><span class="line">            <span class="built_in">strcpy</span>(newpath, path);</span><br><span class="line">            <span class="built_in">strcpy</span>(newpath + <span class="built_in">strlen</span>(path), <span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="built_in">strcpy</span>(newpath + <span class="built_in">strlen</span>(path) + <span class="number">1</span>, f.f_name);</span><br><span class="line">            newpath[len+<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">tree</span>(newpath, f.f_name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    deepth--;</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>
<p>这里实现的tree的展示逻辑和Linux的树状展示逻辑存在较大区别，算是挑战性任务中的较大瑕疵。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_7.jpg" alt></p>
<h4 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h4><p>mkdir是增加文件结构的指令，根据能不能创建多级目录(一口气创建两个及以上)用-p符号作出了区分，同时考虑到了Linux中诸如mkdir -p a/../b 会创建a和b两个目录的情况，即<strong>路径并非提前处理好而是边创建边解析</strong>，代码按照 walk_path 仿写，<strong>利用了文件控制块中未使用过的 f_dir 记录父节点</strong>，极大简化了实现。<br>在此展示fs/fs.c的核心代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">mkdir</span><span class="params">(<span class="type">char</span> *path, <span class="type">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *p;</span><br><span class="line">    <span class="type">char</span> name[MAXNAMELEN];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> *dir, *file;  <span class="comment">//解决 /a/../b</span></span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    path = <span class="built_in">skip_slash</span>(path);</span><br><span class="line">    file = &amp;super-&gt;s_root;</span><br><span class="line">    <span class="comment">//addFileName(file, &quot;/&quot;);</span></span><br><span class="line">    dir = <span class="number">0</span>;</span><br><span class="line">    name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (*path!= <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        dir = file;</span><br><span class="line">        p = path;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(*path != <span class="string">&#x27;/&#x27;</span> &amp;&amp; *path != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            path++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (path - p &gt;= MAXNAMELEN) &#123;</span><br><span class="line">            <span class="keyword">return</span> -E_BAD_PATH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(name, p, path - p); <span class="comment">//path在后 p在前</span></span><br><span class="line">        name[path - p] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        path = <span class="built_in">skip_slash</span>(path);</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;..&quot;</span>) == <span class="number">0</span>) &#123; <span class="comment">//处理.. </span></span><br><span class="line">            dir = dir-&gt;f_dir;  <span class="comment">//指向他的父亲dir</span></span><br><span class="line">            p = path;</span><br><span class="line">            <span class="keyword">while</span>(*path != <span class="string">&#x27;/&#x27;</span> &amp;&amp; *path != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                path++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (path - p &gt;= MAXNAMELEN) &#123;</span><br><span class="line">                <span class="keyword">return</span> -E_BAD_PATH;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memcpy</span>(name, p, path - p);</span><br><span class="line">            name[path - p] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            path = <span class="built_in">skip_slash</span>(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dir-&gt;f_type != FTYPE_DIR) &#123;</span><br><span class="line">            <span class="keyword">return</span> -E_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">        r = <span class="built_in">dir_lookup</span>(dir, name, &amp;file);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span> &amp;&amp; *path == <span class="number">0</span> &amp;&amp; file-&gt;f_type == FTYPE_REG) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;target is a reg file!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> -E_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span> &amp;&amp; *path == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;dir already exist!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123; <span class="comment">//该创建了 还需要判断最后一层若存在是否为reg</span></span><br><span class="line">            <span class="keyword">if</span> (r == -E_NOT_FOUND) &#123;</span><br><span class="line">                <span class="keyword">if</span> (*path == <span class="number">0</span> || op == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">dir_alloc_file</span>(dir, &amp;file) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> r;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">strcpy</span>(file-&gt;f_name, name);</span><br><span class="line">                    <span class="comment">//file-&gt;f_dir = dir;</span></span><br><span class="line">                    file-&gt;f_type = FTYPE_DIR;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;can&#x27;t find dir : %s!\n&quot;</span>, name);</span><br><span class="line">                    <span class="keyword">return</span> r;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，mkdir若不使用 -p 命令则最多只能创建一个目录，多于一个目录会报错；而使用 -p 命令可以创建多级目录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_6.jpg" alt></p>
<h4 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h4><p>touch是用来更新文件日期的指令(文件日期感觉也可以实现，奈何时间有限)，也可以用来创建文件。touch整体思路同mkdir，linux中并没有创建多级目录后再创建文件的 -p 选项，然而我们的YangOS总要有其与众不同之处，因此也支持了类似 mkdir 的 -p 选项。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">touch</span><span class="params">(<span class="type">char</span> *path, <span class="type">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *p;</span><br><span class="line">    <span class="type">char</span> name[MAXNAMELEN];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> *dir, *file;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    path = <span class="built_in">skip_slash</span>(path);</span><br><span class="line">    file = &amp;super-&gt;s_root;</span><br><span class="line">    dir = <span class="number">0</span>;</span><br><span class="line">    name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(*path != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        dir = file;</span><br><span class="line">        p = path;</span><br><span class="line">        <span class="keyword">while</span> (*path != <span class="string">&#x27;/&#x27;</span> &amp;&amp; *path != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            path++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (path - p &gt;= MAXNAMELEN) &#123;</span><br><span class="line">            <span class="keyword">return</span> -E_BAD_PATH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(name, p, path - p);</span><br><span class="line">        name[path - p] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        path = <span class="built_in">skip_slash</span>(path);</span><br><span class="line">        <span class="keyword">if</span> (dir-&gt;f_type != FTYPE_DIR) &#123;</span><br><span class="line">            <span class="keyword">return</span> -E_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">        r = <span class="built_in">dir_lookup</span>(dir, name, &amp;file);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span> &amp;&amp; *path == <span class="number">0</span> &amp;&amp; file-&gt;f_type != FTYPE_REG) &#123; <span class="comment">//找到且最后一级 准确来说是路径有误</span></span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;path wrong can&#x27;t touch!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> -E_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == -E_NOT_FOUND) &#123;</span><br><span class="line">                <span class="keyword">if</span> (*path == <span class="number">0</span> || op == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">dir_alloc_file</span>(dir, &amp;file) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> r;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">strcpy</span>(file-&gt;f_name, name);</span><br><span class="line">                    <span class="keyword">if</span> (*path != <span class="number">0</span>) &#123;</span><br><span class="line">                        file-&gt;f_type = FTYPE_DIR;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        file-&gt;f_type = FTYPE_REG;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;can&#x27;t find dir : %s!\n&quot;</span>, name);</span><br><span class="line">                    <span class="keyword">return</span> r;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>课程组在头文件中给出了CREAT，MKDIR等文件打开方式，但笔者认为创建与打开无关，所以并未使用，不过大体思路无异，通过 ipc 与文件服务进程通信达到创建文件的目的。</p>
<p>演示如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_8.jpg" alt></p>
<h3 id="8-支持相对路径"><a href="#8-支持相对路径" class="headerlink" title="8. 支持相对路径"></a>8. 支持相对路径</h3><p>在进程控制块中维护当前工作目录，初始化为 \ ，并在创建子进程时令子进程继承该值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">env.h:</span><br><span class="line"><span class="type">char</span> env_workingpath[<span class="number">1024</span>];</span><br><span class="line">u_int env_shid;</span><br></pre></td></tr></table></figure>
<p>实现系统调用 syscall_changing_workingpath，顾名思义改变工作目录。</p>
<p><strong>提前声明</strong>：除了mkdir a/../b 这个特殊情况，其他所有涉及路径的指令均采用提前处理的方式，即 a/../b 会当成 b 处理。</p>
<p>由于实现了支持上级目录 .. 和 当前目录 . ，则路径转换需要分两步走，第一步将工作目录和输入的路径拼接，需要考虑拼接处和结尾处 / 的问题；第二步处理拼接后的序列中存在的 .. 以及 . 的情况，最后得到真正可被文件系统识别的路径，cd指令如此，其余涉及路径转化的指令亦是如此。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> truepath[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">path_switch</span><span class="params">(<span class="type">char</span> *path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (path[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memset</span>(truepath, <span class="number">0</span>, <span class="keyword">sizeof</span> truepath);</span><br><span class="line">        <span class="built_in">strcpy</span>(truepath, env-&gt;env_workingpath);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (truepath[<span class="built_in">strlen</span>(truepath) - <span class="number">1</span>] != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            truepath[<span class="built_in">strlen</span>(truepath)] = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">strcpy</span>(truepath + <span class="built_in">strlen</span>(truepath), path);</span><br><span class="line">        <span class="keyword">return</span> truepath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> finalpath[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">parsepath</span><span class="params">(<span class="type">char</span> *path)</span> </span>&#123; <span class="comment">//path是组装好的路径</span></span><br><span class="line">    <span class="type">int</span> p1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(path); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path[i<span class="number">-1</span>] == <span class="string">&#x27;/&#x27;</span> &amp;&amp; path[i] == <span class="string">&#x27;.&#x27;</span> &amp;&amp; ((path[i+<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span> &amp;&amp; (path[i+<span class="number">2</span>] == <span class="string">&#x27;/&#x27;</span> || path[i+<span class="number">2</span>] == <span class="number">0</span>)) || (path[i+<span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span> || path[i+<span class="number">1</span>] == <span class="number">0</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (path[i+<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">                p1 = p1 - <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> (p1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">debugf</span>(<span class="string">&quot;root is first level!\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (; p1 &gt;= <span class="number">0</span>; p1--) &#123;</span><br><span class="line">                    <span class="comment">//debugf(&quot;p1 : %d\n&quot;, p1);</span></span><br><span class="line">                    <span class="keyword">if</span> (finalpath[p1] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (path[i+<span class="number">2</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    i = i + <span class="number">2</span>;</span><br><span class="line">                    p1++;</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// /a/../c</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path[i+<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path[i+<span class="number">1</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">                p1--;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path[i+<span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                i++; <span class="comment">// /a/./c p1指向.</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            finalpath[p1] = path[i];</span><br><span class="line">                p1++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p1 != <span class="number">0</span>) &#123;</span><br><span class="line">        finalpath[p1] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        finalpath[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finalpath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cd 指令并不复杂，因此是一个内部指令，即不需要spawn出子进程专门处理，而是在原shell中执行。pwd 也是如此，直接输出进程控制块中工作目录的内容即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">chdir</span><span class="params">(<span class="type">char</span> *path)</span> </span>&#123;</span><br><span class="line">    path = <span class="built_in">parsepath</span>(<span class="built_in">path_switch</span>(path));</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Stat</span> st;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="keyword">if</span> ((r = <span class="built_in">stat</span>(path, &amp;st)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;cd path wrong!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (st.st_isdir == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;cd path is reg file!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> -E_NOT_FILE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">syscall_change_workingpath</span>(<span class="number">0</span>, path);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于在用户态获取到的内核态的信息，可读，但不可写(应当是硬件约束)，若想写则必须通过系统调用，同时 printf 不允许访问内核地址，两种解决办法，第一种将其在用户态复制一份，第二种把printf的地址检查注释掉(笑。</p>
<p>测试如下:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_10.jpg" alt></p>
<h3 id="9-支持环境变量"><a href="#9-支持环境变量" class="headerlink" title="9. 支持环境变量"></a>9. 支持环境变量</h3><p>declare 可声明的变量包括局部变量(对当前shell可见)以及环境变量(对子shell可见)，对于环境变量笔者实现的是全局可见，应当是有所瑕疵。</p>
<p>为区分局部变量和环境变量，在进程控制块中新增了shid，来区分不同的shell，每当创建新shell时为其赋予不同的id，而当创建其他子进程时继承原shid。在内核态开全局结构体 Environment 来存储所有变量，shid为0时代表环境变量，否则为对应shell的局部变量。在系统调用中实现了 sys_set_env_var 和 sys_get_env_var 实现变量的装载与获取。</p>
<p><strong>env.h</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u_int env_shid;</span><br></pre></td></tr></table></figure>
<p><strong>syscall_all.c</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Environment</span> &#123;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> value[<span class="number">128</span>];</span><br><span class="line">    <span class="type">int</span> shid; <span class="comment">//0 global; other local</span></span><br><span class="line">    <span class="type">char</span> isread; <span class="comment">//0 rdwr; 1 rdonly</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sys_set_env_var</span><span class="params">(u_int envid, <span class="type">int</span> op, <span class="type">char</span> *name, <span class="type">char</span> *value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Env</span> *env;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">envid2env</span>(envid, &amp;env, <span class="number">1</span>) == -E_BAD_ENV) &#123;</span><br><span class="line">        <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> shid = env-&gt;env_shid;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Environment</span> *envir;</span><br><span class="line">    <span class="keyword">if</span> (op == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAXVAR; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (environ[i].name[<span class="number">0</span>] != <span class="number">0</span> &amp;&amp; (environ[i].shid == <span class="number">0</span> || environ[i].shid == shid)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (environ[i].shid == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">printk</span>(<span class="string">&quot;GLOBAL NAME : %s, VALUE : %s\n&quot;</span>, environ[i].name, environ[i].value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (environ[i].shid == shid) &#123;</span><br><span class="line">                    <span class="built_in">printk</span>(<span class="string">&quot;LOCAL NAME : %s, VALUE : %s\n&quot;</span>, environ[i].name, environ[i].value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">1</span> || op == <span class="number">2</span> || op == <span class="number">3</span> || op == <span class="number">4</span>) &#123; <span class="comment">//global rdly</span></span><br><span class="line">        <span class="keyword">if</span> ((envir = <span class="built_in">isexist</span>(name, shid)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (envir-&gt;isread == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">printk</span>(<span class="string">&quot;readonly can&#x27;t change!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">//更改</span></span><br><span class="line">                <span class="built_in">strcpy</span>(envir-&gt;value, value);</span><br><span class="line">                <span class="keyword">if</span> (op == <span class="number">1</span>) &#123;</span><br><span class="line">                    envir-&gt;isread = <span class="number">1</span>;</span><br><span class="line">                    envir-&gt;shid = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">2</span>) &#123;</span><br><span class="line">                    envir-&gt;isread = <span class="number">0</span>;</span><br><span class="line">                    envir-&gt;shid = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">3</span>) &#123;</span><br><span class="line">                    envir-&gt;isread = <span class="number">1</span>;</span><br><span class="line">                    envir-&gt;shid = shid;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">4</span>) &#123;</span><br><span class="line">                    envir-&gt;isread = <span class="number">0</span>;</span><br><span class="line">                    envir-&gt;shid = shid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (op == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">set_envir</span>(<span class="number">1</span>, <span class="number">0</span>, name, value);	</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="built_in">set_envir</span>(<span class="number">0</span>, <span class="number">0</span>, name, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="built_in">set_envir</span>(<span class="number">1</span>, shid, name, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="built_in">set_envir</span>(<span class="number">0</span>, shid, name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == <span class="number">5</span>) &#123; <span class="comment">//clear</span></span><br><span class="line">        <span class="keyword">struct</span> Environment *envir = <span class="built_in">isexist</span>(name, shid);</span><br><span class="line">        <span class="keyword">if</span> (envir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printk</span>(<span class="string">&quot;name no exist!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (envir-&gt;isread == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printk</span>(<span class="string">&quot;can&#x27;t change readonly!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            envir-&gt;name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> * <span class="title">sys_get_env_var</span><span class="params">(u_int envid, <span class="type">char</span> *name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Env</span> *env;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">envid2env</span>(envid, &amp;env, <span class="number">1</span>) == -E_BAD_ENV) &#123;</span><br><span class="line">        <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> shid = env-&gt;env_shid;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Environment</span> *envir = <span class="built_in">isexist</span>(name, shid);</span><br><span class="line">    <span class="keyword">if</span> (envir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> envir-&gt;value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>set 函数根据不同选项分为六种操作(将unset也融合在内)，包括<strong>全局只读，全局可写，局部只读，局部可写，解除变量，输出变量信息</strong>。需要重点注意对于可读变量的操作的限制，不可解除，不可重写，当错误发生时应输出相应信息告知用户。</p>
<p>支持通过 $ 获取环境变量，在解析完一行命令后，需要遍历一遍 argv，若以 $ 开头则尝试获取环境变量值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">	<span class="keyword">if</span> (argv[i][<span class="number">0</span>] == <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">		<span class="type">char</span> *tmp = <span class="built_in">syscall_get_env_var</span>(<span class="number">0</span>, argv[i] + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (tmp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">debugf</span>(<span class="string">&quot;can&#x27;t parse env var!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="built_in">strcpy</span>(argv[i], tmp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试如图，首先在启动的shell里进行测试：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_11.jpg" alt></p>
<p>接着启动子shell进行验证，中间的空行是按了 ctrl+d 终止了子shell回到原始shell：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_12.jpg" alt></p>
<h3 id="10-额外指令"><a href="#10-额外指令" class="headerlink" title="10. 额外指令"></a>10. 额外指令</h3><p>笔者自行添加了四个最常用的指令，分别为rm，rmdir，cp，mv ，各有千秋。</p>
<p>首先是一组相似的删除指令 <strong>rm</strong> 和 <strong>rmdir</strong>：</p>
<ul>
<li>rm：删除文件； -r 递归删除目录及下级所有文件；文件若不为空则需要再次确认是否删除；-f 无需确认</li>
<li>rmdir：删除空目录；-p 依次删除路径中所有空目录，例如 rmdir -p a/b/c，先判断 c 是否为空，若空则删除，再判断 b 是否为空，若空则删除，如此判断到指令开始的路径 a。</li>
</ul>
<p>代码中已有对文件删除相关的函数，彷佛就是为额外新增指令准备的，的确适用于普通的删除操作，然而当涉及判断目录是否为空时存在漏洞。通过阅读代码我们可知，一个文件被删除，将该文件大小 ftruncate 为0，该收回的磁盘块收回，并将该文件控制块的 name 置0，然而该文件控制块并非真正被回收，这导致其父目录的文件大小不能很好的同步(值得一提的是，文件的大小是随字节数的变化而变化，而目录的大小永远都是磁盘块大小的整倍数)。即使由于这次的 remove 导致父目录空了，他的size仍然不为0，因此在remove的时候 f_size 便不可信，需要手动遍历该目录的进程控制块，若 name 都为0，则目录才是真的<strong>空</strong>了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">syn_dir_size</span><span class="params">(<span class="keyword">struct</span> File *dir)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    u_int nblock;</span><br><span class="line">    nblock = dir-&gt;f_size / BY2BLK;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nblock; i++) &#123;</span><br><span class="line">        <span class="type">void</span> *blk;</span><br><span class="line">        <span class="keyword">if</span> ((r = <span class="built_in">file_get_block</span>(dir, i, &amp;blk)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">File</span> *files = (<span class="keyword">struct</span> File *)blk;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">struct</span> File *f = files; f &lt; files + FILE2BLK; ++f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (f-&gt;f_name[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">                    flag = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">file_remove</span><span class="params">(<span class="type">char</span> *path, <span class="type">int</span> force, <span class="type">int</span> rec, <span class="type">int</span> dir)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> *f;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: find the file on the disk.</span></span><br><span class="line">    <span class="keyword">if</span> ((r = <span class="built_in">walk_path</span>(path, <span class="number">0</span>, &amp;f, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;f_type == FTYPE_DIR &amp;&amp; rec == <span class="number">0</span> &amp;&amp; dir == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;dir can&#x27;t remove!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="number">1</span> &amp;&amp; f-&gt;f_type == FTYPE_REG) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;rmdir can&#x27;t rm file!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="number">1</span> &amp;&amp; f-&gt;f_type == FTYPE_DIR &amp;&amp; <span class="built_in">syn_dir_size</span>(f) == <span class="number">0</span>) &#123; <span class="comment">//0 size &gt;0; 1 size = 0</span></span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;rmdir can&#x27;t rm no empty dir!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (((f-&gt;f_type == FTYPE_REG &amp;&amp; f-&gt;f_size != <span class="number">0</span>) || (f-&gt;f_type == FTYPE_DIR &amp;&amp; <span class="built_in">syn_dir_size</span>(f) == <span class="number">0</span>)) &amp;&amp; force == <span class="number">0</span> &amp;&amp; dir == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;you will delate %s, y or n? &quot;</span>, path);</span><br><span class="line">            <span class="type">int</span> c1, c2;</span><br><span class="line">            c1 = <span class="built_in">syscall_cgetc</span>();</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, c1);</span><br><span class="line">            c2 = <span class="built_in">syscall_cgetc</span>();</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ((c1 == <span class="string">&#x27;y&#x27;</span> || c1 == <span class="string">&#x27;Y&#x27;</span>) &amp;&amp; c2 == <span class="number">13</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((c1 == <span class="string">&#x27;n&#x27;</span> || c1 == <span class="string">&#x27;N&#x27;</span>) &amp;&amp; c2 == <span class="number">13</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">debugf</span>(<span class="string">&quot; think more!\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Step 2: truncate it&#x27;s size to zero.</span></span><br><span class="line">    <span class="built_in">file_truncate</span>(f, <span class="number">0</span>); <span class="comment">//只是把当前文件的内容清空 若上层父目录由于此次删除导致文件夹目录也为空 则并没有对父目录进行减小文件大小操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 3: clear it&#x27;s name.</span></span><br><span class="line">    f-&gt;f_name[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 4: flush the file.</span></span><br><span class="line">    <span class="built_in">file_flush</span>(f);</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;f_dir) &#123;</span><br><span class="line">        <span class="built_in">file_flush</span>(f-&gt;f_dir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">free_block新增：</span><br><span class="line"><span class="built_in">memset</span>((<span class="type">void</span> *)<span class="built_in">diskaddr</span>(blockno), <span class="number">0</span>, BY2PG);</span><br><span class="line"><span class="built_in">write_block</span>(blockno);</span><br></pre></td></tr></table></figure>
<p>验证如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_13.jpg" alt></p>
<p>接下来又是一组颇为相似的 <strong>cp</strong>，<strong>mv</strong> 指令，可能出现的情况总结如下。</p>
<ul>
<li>文件 ➡ 存在的文件：改写文件名</li>
<li>文件 ➡ 存在的目录：将文件置于该目录下</li>
<li>文件 ➡ 不存在的路径：合法情况下，默认touch文件并改写文件名</li>
<li>目录 ➡ 不存在的路径：合法情况下，默认mkdir目录并改写目录名</li>
<li>目录 ➡ 存在的目录：将左目录置于在右目录下</li>
<li>目录 ➡ 存在的文件：非法</li>
<li>不存在的路径 ➡ 任何路径：非法</li>
</ul>
<p>cp 若复制目录需使用 -r 选项，mv 则不需要。</p>
<p>cp 指令涉及到深克隆，即要完成对目录的递归拷贝，在深克隆时应注意目录与文件的区别以及进程控制块中变与不变的地方。</p>
<p>mv 实现并不难，完成对文件控制块的<strong>偷天换日</strong>即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">copy_deep</span><span class="params">(<span class="keyword">struct</span> File *file, <span class="keyword">struct</span> File *targetf)</span> </span>&#123; <span class="comment">//dir都是整倍数 reg未必整倍数</span></span><br><span class="line">    <span class="type">int</span> nblock = targetf-&gt;f_size / BY2BLK;</span><br><span class="line">    <span class="keyword">if</span> (targetf-&gt;f_size % BY2BLK != <span class="number">0</span>) &#123;</span><br><span class="line">        nblock++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(file-&gt;f_name, targetf-&gt;f_name);</span><br><span class="line">    file-&gt;f_size = targetf-&gt;f_size;</span><br><span class="line">    file-&gt;f_type = targetf-&gt;f_type;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="type">void</span> *blk, *blk1;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nblock; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((r = <span class="built_in">file_get_block</span>(targetf, i, &amp;blk)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;can&#x27;t get targetf!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((r = <span class="built_in">file_get_block</span>(file, i, &amp;blk1)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;can&#x27;t get file!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetf-&gt;f_type == FTYPE_REG) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(blk1, blk, BY2PG);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetf-&gt;f_type == FTYPE_DIR) &#123;</span><br><span class="line">            <span class="keyword">struct</span> File *files = (<span class="keyword">struct</span> File *)blk;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">struct</span> File *f = files; f &lt; files + FILE2BLK; ++f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (f-&gt;f_name[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">struct</span> <span class="title class_">File</span> *newfile;</span><br><span class="line">                    <span class="built_in">dir_alloc_file</span>(file, &amp;newfile); <span class="comment">//父子绑定</span></span><br><span class="line">                    <span class="built_in">copy_deep</span>(newfile, f);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">copy</span><span class="params">(<span class="type">char</span> *name, <span class="type">char</span> *path, <span class="type">int</span> n)</span> </span>&#123; <span class="comment">//前提 必须都已经存在 复制根目录？</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> *target2, *file, *targetf, *tmp;</span><br><span class="line">    <span class="built_in">walk_path</span>(path, <span class="number">0</span>, &amp;target2, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">walk_path</span>(name, <span class="number">0</span>, &amp;targetf, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((target2-&gt;f_type == FTYPE_REG &amp;&amp; targetf-&gt;f_type == FTYPE_REG) || (target2-&gt;f_type == FTYPE_DIR &amp;&amp; targetf-&gt;f_type == FTYPE_DIR &amp;&amp; n == <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="type">char</span> tmp[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">strcpy</span>(tmp, target2-&gt;f_name);</span><br><span class="line">        <span class="built_in">copy_deep</span>(target2, targetf);</span><br><span class="line">        <span class="built_in">strcpy</span>(target2-&gt;f_name, tmp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> r = <span class="built_in">dir_lookup</span>(target2, targetf-&gt;f_name, &amp;tmp); <span class="comment">//先查看目标目录下有无同名文件</span></span><br><span class="line">    <span class="keyword">if</span> (r != -E_NOT_FOUND) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;%s has same name file %s!\n&quot;</span>, path, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dir_alloc_file</span>(target2, &amp;file);</span><br><span class="line">    <span class="built_in">copy_deep</span>(file, targetf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">move</span><span class="params">(<span class="type">char</span> *name, <span class="type">char</span> *path, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> *target2, *targetf, *file, *tmp;</span><br><span class="line">    <span class="built_in">walk_path</span>(path, <span class="number">0</span>, &amp;target2, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">walk_path</span>(name, <span class="number">0</span>, &amp;targetf, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((target2-&gt;f_type == FTYPE_REG &amp;&amp; targetf-&gt;f_type == FTYPE_REG) || (target2-&gt;f_type == FTYPE_DIR &amp;&amp; targetf-&gt;f_type == FTYPE_DIR &amp;&amp; n == <span class="number">1</span>)) &#123;</span><br><span class="line">        target2-&gt;f_size = targetf-&gt;f_size;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NDIRECT; i++) &#123;</span><br><span class="line">            target2-&gt;f_direct[i] = targetf-&gt;f_direct[i];</span><br><span class="line">        &#125;</span><br><span class="line">        target2-&gt;f_indirect = targetf-&gt;f_indirect;</span><br><span class="line">        targetf-&gt;f_name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> r = <span class="built_in">dir_lookup</span>(target2, targetf-&gt;f_name, &amp;tmp);</span><br><span class="line">    <span class="keyword">if</span> (r != -E_NOT_FOUND) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;%s has same name file %s!\n&quot;</span>, path, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dir_alloc_file</span>(target2, &amp;file);</span><br><span class="line">    <span class="built_in">memcpy</span>(file, targetf, BY2FILE);</span><br><span class="line">    file-&gt;f_dir = target2;</span><br><span class="line">    targetf-&gt;f_name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mv验证：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_14.jpg" alt></p>
<p>cp验证：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/YangYzzzz/image-store@main/C_15.jpg" alt></p>
<p>原有代码的 remove 实现存在些许问题(也许是没有打算令大家实现 remove 操作，总之无论如何，在 remove 后应当对磁盘中相关内容进行同步，同时在释放缓存块时，若不解除映射的话，应该要将页清空。</p>
<h3 id="11-命令自动补全"><a href="#11-命令自动补全" class="headerlink" title="11. 命令自动补全"></a>11. 命令自动补全</h3><p>使用tab键进行代码补全，添加的比较仓促，可以支持命令的补全和路径的补全，但只限于存在唯一解的情况，倘若前缀有多个匹配项则无能为力，但可以支持将所有匹配项打印出来用于提醒(连按两下 tab)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> cmd[<span class="number">1024</span>][<span class="number">16</span>] = &#123;<span class="string">&quot;cd&quot;</span>, <span class="string">&quot;pwd&quot;</span>, <span class="string">&quot;mv&quot;</span>, <span class="string">&quot;cp&quot;</span>, <span class="string">&quot;rm&quot;</span>, <span class="string">&quot;rmdir&quot;</span>, <span class="string">&quot;touch&quot;</span>, <span class="string">&quot;mkdir&quot;</span>, <span class="string">&quot;tree&quot;</span>, <span class="string">&quot;declare&quot;</span>, <span class="string">&quot;unset&quot;</span>, <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;echo&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;ls&quot;</span>&#125;;</span><br><span class="line"><span class="type">int</span> cmd_cnt = <span class="number">15</span>;</span><br><span class="line"><span class="type">char</span> level[<span class="number">1024</span>][<span class="number">64</span>];</span><br><span class="line"><span class="type">char</span> may[<span class="number">1024</span>][<span class="number">10</span>];</span><br><span class="line"><span class="type">int</span> may_cnt;</span><br><span class="line"><span class="type">int</span> level_cnt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">search_maybe_string</span><span class="params">(<span class="type">char</span> *s, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//n = 0 代表搜cmd和Level，n = 1代表前面有/ 只搜索level</span></span><br><span class="line">    may_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(s) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> tmp1[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; level_cnt; j++) &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(tmp1, level[j]);</span><br><span class="line">        tmp1[<span class="built_in">strlen</span>(s)] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(tmp1, s) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(may[may_cnt], level[j]);</span><br><span class="line">            may_cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">15</span>; j++) &#123;</span><br><span class="line">            <span class="comment">//debugf(&quot;cmd[j] %s\n&quot;, cmd[j]);</span></span><br><span class="line">            <span class="built_in">strcpy</span>(tmp1, cmd[j]);</span><br><span class="line">            tmp1[<span class="built_in">strlen</span>(s)] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(tmp1, s) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">strcpy</span>(may[may_cnt], cmd[j]);</span><br><span class="line">                may_cnt++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_level</span><span class="params">(<span class="type">char</span> *path)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> fd, r, n;</span><br><span class="line">    level_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Stat</span> st;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">File</span> f;</span><br><span class="line">    <span class="keyword">if</span> ((r = <span class="built_in">stat</span>(path, &amp;st)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!st.st_isdir) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fd = <span class="built_in">open</span>(path, O_RDONLY);</span><br><span class="line">        <span class="keyword">while</span> ((n = <span class="built_in">readn</span>(fd, &amp;f, <span class="keyword">sizeof</span> f)) == <span class="keyword">sizeof</span> f) &#123;</span><br><span class="line">            <span class="keyword">if</span> (f.f_name[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="built_in">strcpy</span>(level[level_cnt], f.f_name);</span><br><span class="line">                level_cnt++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当识别到 TAB 时，仍然是一通对字符串的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf[i] == <span class="number">9</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;\nyou maybe want: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; may_cnt; j++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;%s &quot;</span>, may[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">debugf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        buf1[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">//封0</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    flag = <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span> search_path[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">char</span> lack_str[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">char</span> para1[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">int</span> tmp1 = pointer, firstcut = pointer;</span><br><span class="line">    <span class="type">int</span> i1;</span><br><span class="line">    <span class="type">int</span> mode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; buf1[firstcut] != <span class="string">&#x27; &#x27;</span> &amp;&amp; buf1[firstcut] != <span class="string">&#x27;/&#x27;</span> &amp;&amp; firstcut &gt;= <span class="number">0</span>; firstcut--) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (buf1[firstcut] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        mode = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    firstcut++;</span><br><span class="line">    <span class="keyword">for</span> (; buf1[tmp1] != <span class="string">&#x27; &#x27;</span> &amp;&amp; tmp1 &gt;= <span class="number">0</span>; tmp1--) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i1 = <span class="number">0</span>, tmp1 = tmp1 + <span class="number">1</span>; tmp1 &lt; pointer; tmp1++, i1++) &#123;</span><br><span class="line">        para1[i1] = buf1[tmp1];</span><br><span class="line">    &#125; </span><br><span class="line">    para1[i1] = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *t = <span class="built_in">parsepath</span>(<span class="built_in">path_switch</span>(para1)); <span class="comment">// /yang/b</span></span><br><span class="line">    <span class="keyword">for</span> (i1 = <span class="built_in">strlen</span>(t); t[i1] != <span class="string">&#x27;/&#x27;</span>; i1--) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(lack_str, t + i1 + <span class="number">1</span>);</span><br><span class="line">    t[i1] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(search_path, t);</span><br><span class="line">    <span class="keyword">if</span> (search_path[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        search_path[<span class="number">0</span>] = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">        search_path[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">get_level</span>(search_path);</span><br><span class="line">    <span class="built_in">search_maybe_string</span>(lack_str, mode);</span><br><span class="line">    <span class="keyword">for</span> (i1 = <span class="number">0</span>; i1 &lt; may_cnt; i1++) &#123;</span><br><span class="line">        <span class="comment">//debugf(&quot;%s\n&quot;, may[i1]);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (may_cnt == <span class="number">1</span>) &#123; <span class="comment">//有唯一解</span></span><br><span class="line">        <span class="type">int</span> diff = <span class="built_in">strlen</span>(may[<span class="number">0</span>]) - <span class="built_in">strlen</span>(lack_str);</span><br><span class="line">        <span class="type">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">        <span class="built_in">strcpy</span>(tmp, buf1 + pointer);</span><br><span class="line">        <span class="built_in">strcpy</span>(buf1 + firstcut, may[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">strcpy</span>(buf1 + firstcut + <span class="built_in">strlen</span>(may[<span class="number">0</span>]), tmp);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = firstcut; k &lt; pointer; k++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">strlen</span>(may[<span class="number">0</span>]); k++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, may[<span class="number">0</span>][k]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">strlen</span>(tmp); k++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;%c&quot;</span>, tmp[k]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">strlen</span>(tmp); k++) &#123;</span><br><span class="line">            <span class="built_in">debugf</span>(<span class="string">&quot;\b&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        pointer = pointer + diff;</span><br><span class="line">        max = max + diff;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三-实验难点"><a href="#三-实验难点" class="headerlink" title="三. 实验难点"></a>三. 实验难点</h2><p>本任务的验证无需一段C代码，而是通过人机交互验证，做起来较为方便且直观。</p>
<p>可以通过代码看出，笔者在实现指令基本功能之外，还在两个方面额外做出了大量工作，第一是指令执行异常时提醒，针对不同的错误情况会输出不同的信息进行提醒，以mkdir为例，当指定路径是一个普通文件时，会提醒 “target is a reg file!”，当没有使用 -p 还企图创建多级目录时，会提醒 “can’t find dir : %s!”；第二便是指令子选项 [-x] 的实现，比如 rm 的 -rf，mkdir，touch 的 -p 等。用户可根据实际需要自由选择想要使用的功能，若错误使用也会出现相应的错误信息进行提醒，十分人性化。</p>
<p>笔者认为 LAB6-challenge 核心挑战点在于<strong>对于字符串的操作与理解</strong>，<strong>对于文件系统与磁盘的各功能的理解与组合</strong>，<strong>对C语言底层逻辑诸如指针和内存间联系的理解</strong>，以及<strong>由于人工输入导致的输入多样性，涉及到的多种情况的处理</strong>，像是oo的第三单元异常处理一样（比如输入路径时结尾带不带/，路径能否被找到，若指令执行出错则是由于哪种错误等等）。shell 重点是人机交互，因此在保证正确性的前提下保证用户的体验是至关重要的，对于既是开发者又是用户的我来说，体感良好。</p>
<p>对于指令的添加，重点难点在于理解 fs.c 中写好的函数，比如 dir_lookup，file_block_walk，file_get_block 等，静下心来去思考每个函数的用途，只要将这些核心函数拼装再进行小小改造，即可实现绝大部分的功能。</p>
<p>笔者一直对于 mos 模拟的磁盘抱有疑问，磁盘在退出后为何不能保留 shell 交互时对磁盘文件的改变。现在的理解是，模拟磁盘终究只是模拟，在上电交互时会保持同步，然而退出后下次会重新初始化磁盘，一开始装载的文件存放在 fs/Makefile 中，可通过修改 Makefile 来调整装载进磁盘的文件。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">fs/Makefile:</span></span><br><span class="line">FSIMGFILES := rootfs/motd rootfs/newmotd <span class="variable">$(USERAPPS)</span> $(fs-files)</span><br></pre></td></tr></table></figure>
<h2 id="四-最终总结"><a href="#四-最终总结" class="headerlink" title="四. 最终总结"></a>四. 最终总结</h2><p>随着挑战性任务的结束，北航操作系统课程终将迎来尾声，在这一学期中，从学习Linux，到启动 mos 操作系统，再到内存管理，进程管理，系统调用，文件系统，shell，基于以往的LAB层层递进，课程设计合理(不愧是计院老三样)，在这一步一个脚印的学习中笔者收获到大量的OS知识，以及对C语言狠狠的查缺补漏了一番。后面的LAB往往要用到前面LAB的内容，有时候你正在写的这部分内容不知道有什么用处，然而等到了下次下下次，当上下文产生联系时你便会豁然开朗，尤其是选择LAB6挑战性任务的笔者更加有体会，在实现 shell 的功能时，要与进程控制块打交道，要与系统调用与进程间通信打交道，更多的要与文件系统打交道，这令我更加理解了由低至高的OS层次架构。</p>
<p>本次实验共用时30h+，在你6并不算繁忙的期末周里，有着足够的时间去静下心去钻研去思考，经常一写一debug就忘记了时间。至于为何选择LAB6挑战性任务，一方面是因为刚刚写完LAB6，认为对其印象更为深刻，另一方面则是认为LAB6的实验效果更为直观，且可以阶段性进行测试，频繁激发自己的成就感，也正是这种成就感会成为我继续完成更多额外工作的动力。诚然，本实验不像其余实验过多的接触内核，实现一套新的算法机制，这一点比较可惜，如果有时间的话很想把每个挑战性任务都完成一遍，但无论如何，笔者在LAB6挑战性任务中耗费了大量的心血，甚至一度找到了当年几个日夜写 P8 的感觉，痛并快乐着的时光总是弥足珍贵。</p>
<p>最后再次感谢一学期以来在OS理论与实验上帮助过我的老师，助教，伙伴们，感谢你们的倾囊相授，也感谢自己坚持到了最后，若如有机会，我也愿意把自己的所学传递给更多的人。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://YangYzzzz.github.io">Yang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://yangyzzzz.github.io/post/318802fe.html">https://yangyzzzz.github.io/post/318802fe.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://YangYzzzz.github.io" target="_blank">Yang's CS World</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></div><div class="post_share"><div class="social-share" data-image="/img/113646857_p0_master1700.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/5d68e32d.html" title="『操作系统』操作系统实验LAB2附——页表自映射"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/119312426_p0_master1700.jpeg" onerror="onerror=null;src='/img/404.jpeg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">『操作系统』操作系统实验LAB2附——页表自映射</div></div></a></div><div class="next-post pull-right"><a href="/post/4f174a3f.html" title="『操作系统』操作系统实验LAB6——管道与Shell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/fufu3.jpeg" onerror="onerror=null;src='/img/404.jpeg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">『操作系统』操作系统实验LAB6——管道与Shell</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/b799ff9.html" title="『操作系统』操作系统第六次理论作业"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/121854553_p0_master1500.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">『操作系统』操作系统第六次理论作业</div></div></a></div><div><a href="/post/3738fa77.html" title="『操作系统』操作系统第五次理论作业"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/121363908_p0_master1600.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">『操作系统』操作系统第五次理论作业</div></div></a></div><div><a href="/post/5d68e32d.html" title="『操作系统』操作系统实验LAB2附——页表自映射"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/119312426_p0_master1700.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">『操作系统』操作系统实验LAB2附——页表自映射</div></div></a></div><div><a href="/post/4f174a3f.html" title="『操作系统』操作系统实验LAB6——管道与Shell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/fufu3.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">『操作系统』操作系统实验LAB6——管道与Shell</div></div></a></div><div><a href="/post/9c179b0b.html" title="『操作系统』操作系统实验LAB5——文件系统与外存"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/119780911_p0_master1700.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">『操作系统』操作系统实验LAB5——文件系统与外存</div></div></a></div><div><a href="/post/74d1b4fb.html" title="『操作系统』操作系统实验LAB4——系统调用与Fork"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/fufu3.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">『操作系统』操作系统实验LAB4——系统调用与Fork</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Yang</div><div class="author-info__description">友链请私戳我</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/YangYzzzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/YangYzzzz" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:21373037@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://blog.csdn.net/weixin_71968907" target="_blank" title="CSDN"><i class="fa fa-book-open"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">青山依旧在，几度夕阳红</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9FLAB6%E6%8C%91%E6%88%98%E6%80%A7%E4%BB%BB%E5%8A%A1%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A"><span class="toc-number">1.</span> <span class="toc-text">操作系统LAB6挑战性任务实验报告</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%AE%9E%E7%8E%B0%E9%9C%80%E6%B1%82"><span class="toc-number">1.1.</span> <span class="toc-text">一.实现需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.</span> <span class="toc-text">二. 实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%80%E8%A1%8C%E5%A4%9A%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 一行多命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%90%8E%E5%8F%B0%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 后台命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BC%95%E5%8F%B7%E6%94%AF%E6%8C%81"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 引号支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%89%E6%A0%87%E4%BA%A4%E4%BA%92"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 光标交互</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%A8%8B%E5%BA%8F%E5%90%8D%E7%A7%B0-b%E7%9A%84%E7%9C%81%E7%95%A5"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 程序名称.b的省略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E8%AE%B0%E5%BD%95%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 记录历史命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%9B%B4%E4%B8%B0%E5%AF%8C%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.7.</span> <span class="toc-text">7. 更丰富的命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tree"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">tree</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mkdir"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">mkdir</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#touch"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">touch</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E6%94%AF%E6%8C%81%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="toc-number">1.2.8.</span> <span class="toc-text">8. 支持相对路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E6%94%AF%E6%8C%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.2.9.</span> <span class="toc-text">9. 支持环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E9%A2%9D%E5%A4%96%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.10.</span> <span class="toc-text">10. 额外指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E5%91%BD%E4%BB%A4%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">1.2.11.</span> <span class="toc-text">11. 命令自动补全</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%AE%9E%E9%AA%8C%E9%9A%BE%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">三. 实验难点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%9C%80%E7%BB%88%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">四. 最终总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/52e1e34e.html" title="『深度学习』动手学深度学习——阅读笔记2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/123182059_p0_master1200.jpeg" onerror="this.onerror=null;this.src='/img/404.jpeg'" alt="『深度学习』动手学深度学习——阅读笔记2"/></a><div class="content"><a class="title" href="/post/52e1e34e.html" title="『深度学习』动手学深度学习——阅读笔记2">『深度学习』动手学深度学习——阅读笔记2</a><time datetime="2025-01-19T13:44:19.349Z" title="发表于 2025-01-19 21:44:19">2025-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/a83ff101.html" title="『信息论』信息论——学习笔记1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/119780754_p0_master1700.jpeg" onerror="this.onerror=null;this.src='/img/404.jpeg'" alt="『信息论』信息论——学习笔记1"/></a><div class="content"><a class="title" href="/post/a83ff101.html" title="『信息论』信息论——学习笔记1">『信息论』信息论——学习笔记1</a><time datetime="2024-10-30T09:46:33.000Z" title="发表于 2024-10-30 17:46:33">2024-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/b2db68a7.html" title="『机器学习系统』OpenMLSYS——阅读笔记2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/119312426_p0_master1700.jpeg" onerror="this.onerror=null;this.src='/img/404.jpeg'" alt="『机器学习系统』OpenMLSYS——阅读笔记2"/></a><div class="content"><a class="title" href="/post/b2db68a7.html" title="『机器学习系统』OpenMLSYS——阅读笔记2">『机器学习系统』OpenMLSYS——阅读笔记2</a><time datetime="2024-10-29T12:14:02.000Z" title="发表于 2024-10-29 20:14:02">2024-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/d00a62b9.html" title="『机器学习系统』OpenMLSYS——阅读笔记1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/fufu4.jpeg" onerror="this.onerror=null;this.src='/img/404.jpeg'" alt="『机器学习系统』OpenMLSYS——阅读笔记1"/></a><div class="content"><a class="title" href="/post/d00a62b9.html" title="『机器学习系统』OpenMLSYS——阅读笔记1">『机器学习系统』OpenMLSYS——阅读笔记1</a><time datetime="2024-10-29T12:14:00.000Z" title="发表于 2024-10-29 20:14:00">2024-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/866b08a7.html" title="『深度学习』动手学深度学习——阅读笔记1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/123230344_p0_master1200.jpeg" onerror="this.onerror=null;this.src='/img/404.jpeg'" alt="『深度学习』动手学深度学习——阅读笔记1"/></a><div class="content"><a class="title" href="/post/866b08a7.html" title="『深度学习』动手学深度学习——阅读笔记1">『深度学习』动手学深度学习——阅读笔记1</a><time datetime="2024-10-29T10:04:51.000Z" title="发表于 2024-10-29 18:04:51">2024-10-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Yang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">You are not too early，you are not too late，you are very much on time in your time zone</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23liK7Xv2gk4Mj8hqI',
      clientSecret: 'a380272ec98afefe58e4fdfacaa66c9eb159e415',
      repo: 'BlogComment',
      owner: 'YangYzzzz',
      admin: ['YangYzzzz'],
      id: '7cdd4fd3107480db0725bdbb9501634a',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><div class="aplayer no-destroy" data-id="2108205877" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="true"></script><script>(() => {
  const isChatBtn = true
  const isChatHideShow = false

  if (isChatBtn) {
    const close = () => {
      Chatra('minimizeWidget')
      Chatra('hide')
    }

    const open = () => {
      Chatra('openChat', true)
      Chatra('show')
    }

    window.ChatraSetup = {
      startHidden: true
    }
  
    window.chatBtnFn = () => {
      const isShow = document.getElementById('chatra').classList.contains('chatra--expanded')
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        Chatra('hide')
      },
      show: () => {
        Chatra('show')
      }
    }
  }

  (function(d, w, c) {
    w.ChatraID = 'Xjgb72cDfiFJXzFty'
    var s = d.createElement('script')
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments)
    }
    s.async = true
    s.src = 'https://call.chatra.io/chatra.js'
    if (d.head) d.head.appendChild(s)
  })(document, window, 'Chatra')

})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>